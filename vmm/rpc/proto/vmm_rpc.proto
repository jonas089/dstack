// SPDX-FileCopyrightText: Â© 2024-2025 Phala Network <dstack@phala.network>
//
// SPDX-License-Identifier: Apache-2.0

syntax = "proto3";

import "google/protobuf/empty.proto";

package vmm;
// Aggregates runtime and provisioning state for a single CVM.
message VmInfo {
  // Unique identifier for the VM
  string id = 1;
  // Name of the VM
  string name = 2;
  // Current status of the VM (e.g., running, stopped)
  string status = 3;
  // Uptime in human-readable format
  string uptime = 4;
  // URL to the guest agent dashboard
  optional string app_url = 5;
  // App ID
  string app_id = 6;
  // Instance ID
  optional string instance_id = 7;
  // Configuration of the VM
  VmConfiguration configuration = 8;
  // Exit time
  optional string exited_at = 9;
  // Boot progress
  string boot_progress = 10;
  // Boot error
  string boot_error = 11;
  // Shutdown progress
  string shutdown_progress = 12;
  // Image version
  string image_version = 13;
  // Events
  repeated GuestEvent events = 14;
}

// Structured log or lifecycle event emitted by the guest or runtime.
message GuestEvent {
  // Event type, e.g. "boot_progress" or "shutdown".
  string event = 1;
  // Human readable payload describing the event.
  string body = 2;
  // Timestamp in milliseconds since Unix epoch
  uint64 timestamp = 3;
}

// Wrapper around a VM identifier to keep RPC signatures consistent.
message Id {
  // Unique identifier for the VM
  string id = 1;
}

// Stable hash of a compose spec used to detect drift between client and VMM.
message ComposeHash {
  string hash = 1;
}

// Full desired state for provisioning or re-provisioning a CVM instance.
message VmConfiguration {
  // Name of the VM
  string name = 1;
  // Image to be used for the VM
  string image = 2;
  // Compose file to be used for the VM
  string compose_file = 3;
  // Number of vCPUs
  uint32 vcpu = 4;
  // Memory in MB
  uint32 memory = 5;
  // Disk size in GB
  uint32 disk_size = 6;
  // Port mapping
  repeated PortMapping ports = 7;
  // Encrypted environment variables
  bytes encrypted_env = 8;
  // App ID.
  // If not provided, it assumes the app is newly created.
  // If provided, and KMS is enabled, it assumes the app is upgraded from given app_id.
  // If provided, and KMS is disabled, it must equal to the actual app_id computed from compose_file, or the VM will fail to start.
  optional string app_id = 9;
  // User config that would be put at /dstack/.user-config in the CVM.
  string user_config = 10;
  // Hugepages enabled
  bool hugepages = 11;
  // Pin NUMA enabled
  bool pin_numa = 12;
  // Gpu config
  GpuConfig gpus = 13;
  // KMS URLs
  repeated string kms_urls = 14;
  // Gateway URLs
  repeated string gateway_urls = 15;
  // The VM is stopped
  bool stopped = 16;
  // Disable confidential computing (fallback to non-TEE VM).
  bool no_tee = 17;
}

// Requested GPU layout for a CVM.
message GpuConfig {
  // GPUs
  repeated GpuSpec gpus = 1;
  // Gpu attach mode
  string attach_mode = 2;
}

// Identifies a physical GPU on the host.
message GpuSpec {
  string slot = 1;
}

// Describes how host ports are forwarded into the CVM network namespace.
message PortMapping {
  // Protocol
  string protocol = 1;
  // Host port
  uint32 host_port = 2;
  // VM port
  uint32 vm_port = 3;
  // Host address
  string host_address = 4;
}

// Partial configuration used when mutating an existing VM.
message UpdateVmRequest {
  // ID of the VM
  string id = 1;
  // Compose file to be used for the VM
  string compose_file = 2;
  // Optional update encrypted environment variables. Leave empty to not update.
  bytes encrypted_env = 3;
  // Optional update user config. Leave empty to not update.
  string user_config = 4;
  // Optional update port mapping.
  bool update_ports = 5;
  // Port mapping
  repeated PortMapping ports = 7;
  // Optional update KMS URLs.
  bool update_kms_urls = 8;
  repeated string kms_urls = 9;
  // Optional update gateway URLs.
  bool update_gateway_urls = 10;
  repeated string gateway_urls = 11;
  // gpus
  GpuConfig gpus = 13;
  // Optional compute resource updates. Leave unset to keep current configuration.
  optional uint32 vcpu = 14;
  optional uint32 memory = 15;
  optional uint32 disk_size = 16;
  optional string image = 17;
  // Disable or re-enable TEE for an existing VM.
  optional bool no_tee = 18;
}

// Parameters for listing CVMs with pagination and keyword filtering.
message StatusRequest {
  // List of VM IDs
  repeated string ids = 1;
  // Brief (Don't include VM configuration)
  bool brief = 2;
  // Filter by keyword
  string keyword = 3;
  // Page number
  uint32 page = 4;
  // Page size
  uint32 page_size = 5;
}

// Summary of the current fleet status.
message StatusResponse {
  // List of VMs
  repeated VmInfo vms = 1;
  // Port mapping enabled
  bool port_mapping_enabled = 2;
  // Total number of VMs
  uint32 total = 3;
}

// Available base images for the VMM to launch.
message ImageListResponse {
  repeated ImageInfo images = 1;
}

// Metadata describing an OCI image published to the cluster.
message ImageInfo {
  string name = 1;
  string description = 2;
  string version = 3;
  bool is_dev = 4;
}

// App identifier used for encrypting env vars and routing telemetry.
message AppId {
  bytes app_id = 1;
}

// Response with the KMS-backed public key used for env encryption plus audit signature.
message PublicKeyResponse {
  bytes public_key = 1;
  bytes signature = 2;
}

// Optional VM info payload returned by GetInfo.
message GetInfoResponse {
  bool found = 1;
  optional VmInfo info = 2;
}

// Input used when resizing compute or storage for a VM.
message ResizeVmRequest {
  // Unique identifier for the VM
  string id = 1;
  // Number of vCPUs
  optional uint32 vcpu = 2;
  // Memory in MB
  optional uint32 memory = 3;
  // Disk size in GB
  optional uint32 disk_size = 4;
  // Image name
  optional string image = 5;
}

// Tunables for the KMS integration.
message KmsSettings {
  string url = 1;
  repeated string urls = 2;
}

// Details about the HTTP gateway that fronts the CVMs.
message GatewaySettings {
  string url = 1;
  string base_domain = 2;
  uint32 port = 3;
  uint32 agent_port = 4;
  repeated string urls = 5;
}

// Capacity caps enforced by the scheduler.
message ResourcesSettings {
  uint32 max_cvm_number = 1; // equals to the cid pool size.
  uint32 max_allocable_vcpu = 2;
  uint32 max_allocable_memory_in_mb = 3; // in MB.
}

// Aggregated metadata exposed through GetMeta.
message GetMetaResponse {
  KmsSettings kms = 1;
  GatewaySettings gateway = 2;
  ResourcesSettings resources = 3;
}

// Build information for the running VMM binary.
message VersionResponse {
  string version = 1;
  string rev = 2;
}

// Available GPUs and policy flags.
message ListGpusResponse {
  repeated GpuInfo gpus = 1;
  bool allow_attach_all = 2;
}

// Counts applied when reloading persistent VM state from disk.
message ReloadVmsResponse {
  uint32 loaded = 1;      // Number of VMs that were loaded
  uint32 updated = 2;     // Number of VMs that were updated
  uint32 removed = 3;     // Number of VMs that were removed
}

// Metadata for a single GPU discovered on the host.
message GpuInfo {
  string slot = 1;
  string product_id = 2;
  string description = 3;
  bool is_free = 4;
}

// Exposes lifecycle and metadata management RPCs for dstack-vmm.
service Vmm {
  // RPC to create a VM
  rpc CreateVm(VmConfiguration) returns (Id);
  // RPC to start a VM
  rpc StartVm(Id) returns (google.protobuf.Empty);
  // RPC to stop a VM
  rpc StopVm(Id) returns (google.protobuf.Empty);
  // RPC to remove a VM
  rpc RemoveVm(Id) returns (google.protobuf.Empty);
  // RPC to upgrade an app. Deprecated, use UpdateVm instead.
  rpc UpgradeApp(UpdateVmRequest) returns (Id);
  // RPC to update a VM
  rpc UpdateVm(UpdateVmRequest) returns (Id);
  // Shutdown a VM
  rpc ShutdownVm(Id) returns (google.protobuf.Empty);
  // RPC to resize a VM. Deprecated, use UpdateVm instead.
  rpc ResizeVm(ResizeVmRequest) returns (google.protobuf.Empty);
  // RPC to compute the compose hash, it's helpful for debugging & developing SDK.
  rpc GetComposeHash(VmConfiguration) returns (ComposeHash);

  // RPC to list all VMs
  rpc Status(StatusRequest) returns (StatusResponse);
  // RPC to list all available images
  rpc ListImages(google.protobuf.Empty) returns (ImageListResponse);

  // Get Env encrypt public key
  rpc GetAppEnvEncryptPubKey(AppId) returns (PublicKeyResponse);

  // Get VM info by ID
  rpc GetInfo(Id) returns (GetInfoResponse);

  // Get version info of the dstack-vmm
  rpc Version(google.protobuf.Empty) returns (VersionResponse);

  // Get version info of the dstack-vmm
  rpc GetMeta(google.protobuf.Empty) returns (GetMetaResponse);

  // List GPUs
  rpc ListGpus(google.protobuf.Empty) returns (ListGpusResponse);

  // Reload VMs directory and sync with memory state
  rpc ReloadVms(google.protobuf.Empty) returns (ReloadVmsResponse);
}
